# Animated GIF Generation Plan for VideoView

## Overview
Generate a 20-second animated GIF using AI that depicts the psychology experiment with colored stick figures, showing the actions of researchers and participants with relevant background details (costumes, devices, settings).

## Current State
- `VideoView.swift` displays a static `StickFiguresView` (two facing stick figures)
- Has voting functionality (like/dislike)
- No animation or dynamic content currently

## Requirements
1. **20-second animated GIF** depicting the experiment
2. **Stick figure characters** representing researchers and participants
3. **Actions and movements** showing what happened in the experiment
4. **Background details** - costumes, devices, lab settings, props as needed
5. **Color** - not just black and white stick figures
6. **Auto-play** - starts immediately when entering VideoView
7. **Loop** - replays immediately when GIF ends
8. **Fallback** - show static StickFiguresView if generation fails

## Technical Approach: Hybrid (Imagen + SwiftUI Animations)

Generate key frames with Gemini Imagen 3, then use SwiftUI transitions and animations between frames for smoother, more dynamic motion. This combines AI-generated visuals with fluid native animations.

**Key Features:**
- 10 key frames generated by Imagen 3
- SwiftUI `.transition()` and `.animation()` for smooth crossfades
- Optional movement animations (characters sliding, scaling, fading)
- 2 seconds per frame with 0.5s transition overlap = ~20 seconds total

---

## Implementation Plan

### Step 1: Create GIF Generation Service
**New File:** `Psychly/GIFGenerationService.swift`

```swift
class GIFGenerationService {
    static let shared = GIFGenerationService()

    // Generate frames for an experiment animation
    func generateExperimentFrames(experiment: Experiment) async throws -> [UIImage]

    // Generate a single frame with specific scene description
    func generateFrame(sceneDescription: String) async throws -> UIImage

    // Get cached frames from Firestore Storage
    func getCachedFrames(experimentDate: String) async -> [UIImage]?

    // Cache frames to Firestore Storage
    func cacheFrames(frames: [UIImage], experimentDate: String) async throws
}
```

### Step 2: Add Gemini Image Generation
**Modify:** `Psychly/GeminiService.swift`

Add methods for:
1. `generateExperimentStoryboard(experiment: Experiment) -> [String]` - Creates 10 scene descriptions
2. `generateSceneImage(description: String) -> Data` - Generates image using Imagen 3

**Prompt Template for Storyboard:**
```
Given this psychology experiment:
Name: {name}
Description: {info}
Researchers: {researchers}

Create a 10-scene storyboard for a 20-second animation showing this experiment.
Each scene should:
- Use colorful stick figures (researchers in blue, participants in green)
- Show specific actions and movements
- Include relevant props, costumes, or devices
- Have a simple colored background appropriate to the setting

Return JSON array of 10 scene descriptions.
```

**Prompt Template for Image Generation:**
```
Create a simple, colorful illustration in a stick figure style showing:
{scene_description}

Style: Colored stick figures with simple shapes, bright colors, clean background.
The image should be suitable for animation.
```

### Step 3: Create Animated Experiment View Component (Hybrid)
**New File:** `Psychly/AnimatedExperimentView.swift`

```swift
struct AnimatedExperimentView: View {
    let frames: [UIImage]
    @State private var currentFrameIndex = 0
    @State private var animationPhase: CGFloat = 0

    // Timer for frame advancement (2 seconds per frame)
    let timer = Timer.publish(every: 2.0, on: .main, in: .common).autoconnect()

    var body: some View {
        ZStack {
            // Current frame with animations
            Image(uiImage: frames[currentFrameIndex])
                .resizable()
                .aspectRatio(contentMode: .fit)
                .id(currentFrameIndex) // Forces view recreation for transition
                .transition(.asymmetric(
                    insertion: .opacity.combined(with: .scale(scale: 1.05)),
                    removal: .opacity.combined(with: .scale(scale: 0.95))
                ))
                .animation(.easeInOut(duration: 0.5), value: currentFrameIndex)

            // Subtle movement overlay (characters "breathing"/moving)
            Image(uiImage: frames[currentFrameIndex])
                .resizable()
                .aspectRatio(contentMode: .fit)
                .opacity(0.1)
                .scaleEffect(1.0 + sin(animationPhase) * 0.02)
                .animation(.easeInOut(duration: 1.0).repeatForever(autoreverses: true), value: animationPhase)
        }
        .onAppear {
            animationPhase = 1.0 // Trigger continuous subtle animation
        }
        .onReceive(timer) { _ in
            withAnimation(.easeInOut(duration: 0.5)) {
                currentFrameIndex = (currentFrameIndex + 1) % frames.count
            }
        }
    }
}
```

**Animation Effects:**
- **Crossfade transition** - Smooth opacity blend between frames
- **Scale transition** - Slight zoom in/out during transitions
- **Breathing effect** - Subtle continuous scale animation for liveliness
- **20-second loop** - 10 frames × 2 seconds each

### Step 4: Update VideoView
**Modify:** `Psychly/VideoView.swift`

```swift
struct VideoView: View {
    let date: Date
    @StateObject private var voteManager = VoteManager()
    @StateObject private var experimentManager = ExperimentManager()
    @State private var frames: [UIImage] = []
    @State private var isLoading = true
    @State private var generationFailed = false

    var body: some View {
        VStack(spacing: 24) {
            Spacer()

            if isLoading {
                ProgressView("Generating animation...")
            } else if generationFailed || frames.isEmpty {
                // Fallback to static stick figures
                StickFiguresView()
                    .frame(height: 200)
            } else {
                // Animated frames
                AnimatedExperimentView(frames: frames)
                    .frame(height: 300)
            }

            // Voting buttons (unchanged)
            // ...

            Spacer()
        }
        .task {
            await loadAnimation()
        }
    }

    private func loadAnimation() async {
        // 1. Load experiment data
        await experimentManager.loadExperiment(for: date)

        guard let experiment = experimentManager.experiment else {
            generationFailed = true
            isLoading = false
            return
        }

        // 2. Check cache first
        if let cached = await GIFGenerationService.shared.getCachedFrames(experimentDate: dateString) {
            frames = cached
            isLoading = false
            return
        }

        // 3. Generate new frames
        do {
            frames = try await GIFGenerationService.shared.generateExperimentFrames(experiment: experiment)
            isLoading = false
        } catch {
            generationFailed = true
            isLoading = false
        }
    }
}
```

### Step 5: Add Firestore Storage for Caching
**Modify:** `Psychly/GIFGenerationService.swift`

- Store generated frames in Firebase Storage at `animations/{dateString}/frame_{index}.png`
- Check cache before generating new frames
- Cache expires after 30 days

### Step 6: Update Experiment Model (Optional)
**Modify:** `Psychly/Experiment.swift`

Add optional field:
```swift
var animationGenerated: Bool?
```

---

## Files to Create/Modify

| File | Changes |
|------|---------|
| **NEW** `Psychly/GIFGenerationService.swift` | Frame generation, caching logic |
| **NEW** `Psychly/AnimatedExperimentView.swift` | SwiftUI view for frame animation |
| `Psychly/GeminiService.swift` | Add image generation methods |
| `Psychly/VideoView.swift` | Integrate animated view with fallback |

---

## API Requirements

### Gemini Imagen 3 API
- Endpoint: `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict`
- Requires: `GEMINI_API_KEY` (already have)
- Note: May need to enable Imagen API separately in Google Cloud Console

### Alternative: If Imagen not available
Use DALL-E 3 or Stability AI as backup image generation service.

---

## Animation Flow

```
User taps "Video" button
        ↓
VideoView appears with loading spinner
        ↓
Check Firebase Storage cache for frames
        ↓
    [Cache hit] → Load frames → Start animation
        ↓
    [Cache miss] → Generate storyboard via Gemini
        ↓
    Generate 10 images via Imagen 3
        ↓
    Cache to Firebase Storage
        ↓
    Start animation (2 sec per frame, loops)
        ↓
    [On error] → Show static StickFiguresView
```

---

## Frame Timing & Animation
- **10 key frames** generated by Imagen 3
- **2 seconds display** per frame
- **0.5 second transition** (crossfade + scale) between frames
- **Continuous breathing animation** - subtle 2% scale oscillation
- **Total loop duration**: ~20 seconds
- **Seamless loop** - frame 9 transitions smoothly back to frame 0

### Animation Timeline
```
Frame 0 ──[2s]──> Transition [0.5s] ──> Frame 1 ──[2s]──> ...
                    ↑ crossfade
                    ↑ scale 1.05 → 0.95
```

---

## Verification
1. Navigate to VideoView → verify loading spinner appears
2. Wait for generation → verify animation plays automatically
3. Watch full 20 seconds → verify it loops seamlessly
4. Return to same experiment → verify cached frames load instantly
5. Test with no network → verify fallback to static StickFiguresView
6. Check Firebase Storage → verify frames are cached

---

## Considerations

### Performance
- Generate frames in background
- Cache aggressively to avoid repeated API calls
- Preload frames before showing animation

### Cost
- Imagen 3 API has usage costs
- Caching reduces repeated generation
- Consider daily generation limit

### Fallback Chain
1. Try cached frames
2. Try generating new frames
3. Fall back to static StickFiguresView
